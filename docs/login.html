<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Portafolio</title>
    <link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%239d50bb'/%3E%3Ctext x='50%' y='55%' text-anchor='middle' dominant-baseline='middle' font-size='40' font-family='Poppins, Arial, sans-serif' fill='white'%3EA%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        *{box-sizing:border-box}
        @keyframes bgshift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        body{font-family:'Poppins',Arial,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f6f0ff,#ffffff);}
        .login-container{position:relative;width:100%;max-width:520px;margin:4rem auto;padding:2.4rem;border-radius:18px;background:linear-gradient(#ffffff,#ffffff) padding-box,linear-gradient(135deg,#6e48aa,#9d50bb) border-box;border:1px solid transparent;box-shadow:0 20px 40px rgba(0,0,0,0.12);backdrop-filter:saturate(1.2) blur(4px)}
        .login-header{display:flex;align-items:center;gap:0.9rem;margin-bottom:1rem}
        .logo-circle{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#6e48aa,#9d50bb);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
        .hint{color:#7a5ab0;font-size:0.9rem;margin-top:-4px}
        h2{color:#5b3ea6;margin:0}
        .form-group{margin-bottom:1rem}
        .form-group input{width:100%;padding:0.95rem 1rem;border:1px solid #e7e3f3;border-radius:10px;font-size:1rem;transition:border-color .2s,box-shadow .2s}
        .form-group input:focus{outline:none;border-color:#9d50bb;box-shadow:0 0 0 3px rgba(157,80,187,.15)}
        .small-btn{width:100%;padding:0.85rem;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:transform .08s ease,box-shadow .2s}
        .small-btn:hover{transform:translateY(-1px);box-shadow:0 8px 16px rgba(0,0,0,.1)}
        .row{display:flex;gap:.7rem}
        #adminPanelBtn{background:#2f2d3a;color:#fff}
    </style>
            
            </head>
            <body class="theme-original">
            
                <div class="login-container">
                    <div class="login-header">
                        <div class="logo-circle">A</div>
                        <h2>Iniciar Sesión</h2>
                        <div class="hint">Accede para editar tu portafolio</div>
                    </div>
            
                    <form id="loginForm">
                        <div class="form-group" style="position:relative;">
                            <input type="text" id="username" required placeholder="Usuario" style="padding-left:2.2rem; width:100%;">
                        </div>
                        <div class="form-group" style="position:relative;">
                            <input type="password" id="password" required placeholder="Contraseña" style="padding-left:2.2rem; width:100%;">
                        </div>
                        <button type="submit" class="small-btn" style="background: linear-gradient(135deg,#6e48aa,#9d50bb); color:white;">Ingresar</button>
                        <div style="height:0.5rem"></div>
                        <div class="row">
                            <button type="button" id="guestBtn" class="small-btn" style="background:#eee;">Modo Invitado</button>
                            <button type="button" id="adminPanelBtn" class="small-btn" style="background:#444; color:white;">Panel de administración</button>
                        </div>
                    </form>
                </div>
            
                <script src="app.js"></script>
                <script>
                    // Obtener IP pública y guardarla (si falla, el sistema sigue funcionando sin IP-lock)
                    async function obtenerIPyGuardar() {
                        try {
                            const r = await fetch('https://api.ipify.org?format=json');
                            if (!r.ok) throw new Error('no ip');
                            const j = await r.json();
                            sessionStorage.setItem('ipUser', j.ip);
                        } catch (e) {
                            console.warn('No se pudo obtener IP pública:', e);
                        }
                    }
                    obtenerIPyGuardar();
                    function apiBase(){ return localStorage.getItem('api_base') || (location.hostname.endsWith('github.io') ? '' : ''); }
                    async function fetchJson(path, opts){ const base = apiBase(); const url = (base ? base : '') + path; const resp = await fetch(url, opts); const ct = resp.headers.get('content-type')||''; if(ct.includes('application/json')){ return { resp, json: await resp.json() }; } const t = await resp.text(); throw new Error('Respuesta no JSON desde '+url+': '+t.slice(0,80)); }
            
                    // Manejo del formulario: intentar login en el backend (/api/login)
                    async function serverLogin(identifier, password) {
                        try {
                            const isEmail = identifier.includes('@');
                            let payload = isEmail ? { email: identifier, password } : { username: identifier, password };
                            let { resp, json } = await fetchJson('/api/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
                            if (!resp.ok && !isEmail && json && typeof json.error === 'string' && json.error.toLowerCase().includes('faltan campos')) {
                                payload = { email: identifier, password };
                                ({ resp, json } = await fetchJson('/api/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }));
                            }
                            if (!resp.ok && !isEmail && identifier.toLowerCase() === 'antony') {
                                payload = { email: 'amirandreve507@gmail.com', password };
                                ({ resp, json } = await fetchJson('/api/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }));
                            }
                            if (!resp.ok) { const msg = (json && json.error) ? json.error : 'Login fallido'; alert(msg); return false; }
                            if (json && json.token) sessionStorage.setItem('token', json.token);
                            if (json && json.user && json.user.role) sessionStorage.setItem('role', json.user.role);
                            if (json && json.user) sessionStorage.setItem('usuario', json.user.nombre || json.user.email || json.user.Email || '');
                            window.location.href = 'index.html';
                            return true;
                        } catch (e) {
                            console.error('Login error', e);
                            alert('Error comunicándose con el servidor: '+e.message);
                            return false;
                        }
                    }

                    document.getElementById('loginForm').addEventListener('submit', function(e){
                        e.preventDefault();
                        const username = document.getElementById('username').value.trim();
                        const password = document.getElementById('password').value.trim();
                        if(!username || !password){ alert('Completa ambos campos'); return }
                        // Intentar login en el backend. Si tu cuenta es de demo local (Antony/admin) el servidor también debe tener esa cuenta.
                        serverLogin(username, password);
                    });

                    document.getElementById('guestBtn').addEventListener('click', function(){ sessionStorage.setItem('guestMode','true'); window.location.href='index.html' });
            
                    // Mostrar u ocultar el botón de panel admin sólo por role (Manager) o usuario demo 'Antony'
                    function updateAdminBtnVisibility() {
                        const btn = document.getElementById('adminPanelBtn');
                        const role = sessionStorage.getItem('role');
                        const usuario = sessionStorage.getItem('usuario');
                        if (role === 'Manager' || usuario === 'Antony') {
                            btn.style.display = '';
                        } else {
                            btn.style.display = 'none';
                        }
                    }
                    updateAdminBtnVisibility();
                    window.addEventListener('focus', updateAdminBtnVisibility);

                    document.getElementById('adminPanelBtn').addEventListener('click', function(){
                        const role = sessionStorage.getItem('role');
                        const usuario = sessionStorage.getItem('usuario');
                        if (role === 'Manager' || usuario === 'Antony') {
                            window.location.href = 'admin.html';
                        } else {
                            alert('No tienes permisos para acceder al panel de administración');
                        }
                    });
                </script>
            </body>
            </html>
