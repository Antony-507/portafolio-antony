<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Portafolio</title>
    <link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%239d50bb'/%3E%3Ctext x='50%' y='55%' text-anchor='middle' dominant-baseline='middle' font-size='40' font-family='Poppins, Arial, sans-serif' fill='white'%3EA%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        body{font-family: 'Poppins', Arial, sans-serif; background: linear-gradient(180deg,#faf6ff,#fff); margin:0}
            * { box-sizing: border-box; }
            .login-container{max-width:420px;margin:5rem auto;padding:2.5rem;background:white;border-radius:16px;box-shadow:0 15px 30px rgba(0,0,0,0.12)}
        .login-container h2{color:#6e48aa;text-align:center;margin-bottom:1rem}
            .form-group { margin-bottom: 1rem; }
            .form-group label { display:block; margin-bottom:0.5rem }

            /* Contenedor para input con icono */
            .input-with-icon { position: relative; }
            .input-with-icon .input-icon {
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                width: 44px;
                height: 44px;
                border-radius: 10px;
                background: #6e48aa;
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                pointer-events: none; /* evita que el icono interfiera con clics */
                z-index: 2;
            }
            .input-with-icon input {
                width: 100%;
                padding: 0.9rem 1rem 0.9rem 64px; /* espacio para el icono */
                border: 1px solid #eee;
                border-radius: 8px;
                font-size: 1rem;
                background-repeat: no-repeat;
                background-position: left center;
            }

            /* Por defecto ocultar el botón de panel admin en el cliente; se muestra solo si hay rol Manager */
            #adminPanelBtn { display: none; }

            /* Evitar el icono morado / background que Chrome/Edge añade por autofill */
                        input:-webkit-autofill,
                        input:-webkit-autofill:hover,
                        input:-webkit-autofill:focus,
                        input:-webkit-autofill:active {
                            -webkit-box-shadow: 0 0 0px 1000px white inset !important;
                            -webkit-text-fill-color: #000 !important;
                        }
                </style>
            
            </head>
            <body class="theme-original">
            
                <div class="login-container">
                    <div class="login-header">
                        <div class="logo-circle">A</div>
                        <h2>Iniciar Sesión</h2>
                        <div class="hint">Accede para editar tu portafolio</div>
                    </div>
            
                    <form id="loginForm">
                        <div class="form-group" style="position:relative;">
                            <input type="text" id="username" required placeholder="Usuario" style="padding-left:2.2rem; width:100%;">
                        </div>
                        <div class="form-group" style="position:relative;">
                            <input type="password" id="password" required placeholder="Contraseña" style="padding-left:2.2rem; width:100%;">
                        </div>
                        <button type="submit" class="small-btn" style="background: linear-gradient(135deg,#6e48aa,#9d50bb); color:white;">Ingresar</button>
                        <div style="height:0.5rem"></div>
                        <div class="row">
                            <button type="button" id="guestBtn" class="small-btn" style="background:#eee;">Modo Invitado</button>
                            <button type="button" id="adminPanelBtn" class="small-btn" style="background:#444; color:white;">Panel de administración</button>
                        </div>
                    </form>
                </div>
            
                <script src="app.js"></script>
                <script>
                    // Obtener IP pública y guardarla (si falla, el sistema sigue funcionando sin IP-lock)
                    async function obtenerIPyGuardar() {
                        try {
                            const r = await fetch('https://api.ipify.org?format=json');
                            if (!r.ok) throw new Error('no ip');
                            const j = await r.json();
                            sessionStorage.setItem('ipUser', j.ip);
                        } catch (e) {
                            console.warn('No se pudo obtener IP pública:', e);
                        }
                    }
                    obtenerIPyGuardar();
            
                    // Manejo del formulario: intentar login en el backend (/api/login)
                    async function serverLogin(identifier, password) {
                        try {
                            const resp = await fetch('/api/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(identifier.includes('@') ? { email: identifier, password } : { username: identifier, password })
                            });
                            const json = await resp.json().catch(()=>null);
                            if (!resp.ok) {
                                const msg = (json && json.error) ? json.error : 'Login fallido';
                                alert(msg);
                                return false;
                            }
                            // Guardar token y role en sessionStorage para la UI
                            if (json && json.token) sessionStorage.setItem('token', json.token);
                            if (json && json.user && json.user.role) sessionStorage.setItem('role', json.user.role);
                            if (json && json.user && (json.user.email || json.user.Email)) sessionStorage.setItem('usuario', json.user.email || json.user.Email);
                            // Redirigir al index principal
                            window.location.href = 'index.html';
                            return true;
                        } catch (e) {
                            console.error('Login error', e);
                            alert('Error comunicándose con el servidor');
                            return false;
                        }
                    }

                    document.getElementById('loginForm').addEventListener('submit', function(e){
                        e.preventDefault();
                        const username = document.getElementById('username').value.trim();
                        const password = document.getElementById('password').value.trim();
                        if(!username || !password){ alert('Completa ambos campos'); return }
                        // Intentar login en el backend. Si tu cuenta es de demo local (Antony/admin) el servidor también debe tener esa cuenta.
                        serverLogin(username, password);
                    });

                    document.getElementById('guestBtn').addEventListener('click', function(){ sessionStorage.setItem('guestMode','true'); window.location.href='index.html' });
            
                    // Mostrar u ocultar el botón de panel admin sólo por role (Manager) o usuario demo 'Antony'
                    function updateAdminBtnVisibility() {
                        const btn = document.getElementById('adminPanelBtn');
                        const role = sessionStorage.getItem('role');
                        const usuario = sessionStorage.getItem('usuario');
                        if (role === 'Manager' || usuario === 'Antony') {
                            btn.style.display = '';
                        } else {
                            btn.style.display = 'none';
                        }
                    }
                    updateAdminBtnVisibility();
                    window.addEventListener('focus', updateAdminBtnVisibility);

                    document.getElementById('adminPanelBtn').addEventListener('click', function(){
                        const role = sessionStorage.getItem('role');
                        const usuario = sessionStorage.getItem('usuario');
                        if (role === 'Manager' || usuario === 'Antony') {
                            window.location.href = 'admin.html';
                        } else {
                            alert('No tienes permisos para acceder al panel de administración');
                        }
                    });
                </script>
            </body>
            </html>
